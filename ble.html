<html>
<head>
<meta charset="utf-8">
<title>AZTOOL</title>
<link rel="stylesheet" type="text/css" href="./css/remodal.css?1">
<link rel="stylesheet" type="text/css" href="./css/remodal-default-theme.css">
<link rel="stylesheet" type="text/css" href="./css/main.css">
<script type="text/javascript" src="./js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="./js/jquery-ui.js"></script>
</head>
<body>

<div id="main_box">
    <a id="ble_btn" class="save_bbutton">ble_btn</a><br>
    <br>
    <div id="ble_info"></div>
</div>

<script type="text/javascript">
var ble;
var ble_server, ble_service, ble_characteristic;
$(function(){
    $("#ble_btn").click(async function() {
        var s = "";
        /*
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true
        }).then(device => device.gatt.connect()).then(server => {
            // Battery Serviceを取得中…
            console.log(server);
            return server.getPrimaryService('battery_service');
        });
        */
       // service list https://github.com/WebBluetoothCG/registries/blob/master/gatt_assigned_services.txt
        const device = await navigator.bluetooth.requestDevice({
            filters: [
                { services: [
                    // "0000180f-0000-1000-8000-00805f9b34fb" // バッテリー
                    // "0000180f" // バッテリー
                    // "00001812-0000-1000-8000-00805f9b34fb" // HID
                    // ,"1812-0000-1000-8000-00805f9b34fb"
                    "00002a4d-0000-1000-8000-00805f9b34fb" // 2A4D  char
                ] },
                { namePrefix: "azpocket" }
            ]
        })
        .then(device => device.gatt.connect()).then(server => {
            ble_server = server;
            console.log(server);
            return server.getPrimaryService(0x2a4d);
        })
        .then(service => {
            ble_service = service;
            console.log(service);
            return service.getCharacteristic('00002a4d-0000-1000-8000-00805f9b34fb');
        })
        .then(characteristic => {
            ble_characteristic = characteristic;
            console.log(characteristic);
            return characteristic.readValue();
        }).catch(error => {
            $("#ble_info").html("error:" + error);
        });

        ble = device;

        /*
        console.log('選択されたデバイス:', device.name);
        s += "device.name: " + device.id + "<br>";
        s += "device.name: " + device.name + "<br>";
        $("#ble_info").html(s);
        */
    });
});
</script>

</body>
</html>
